name: PR
on:
  pull_request:
    types: [opened, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-description:
    name: Check Description
    runs-on: ubuntu-latest
    steps:
      - name: Extract PR number
        id: pr_number
        run: echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Check PR Description
        uses: actions/github-script@v7
        id: validate_description
        with:
          script: |
            const requiredSections = [
              "## Description",
              "## Test plan",
              "## Documentation update"
            ];
            
            const prBody = context.payload.pull_request.body || "";
            const missingSections = requiredSections.filter(section => 
              !prBody.includes(section) || prBody.split(section)[1].trim().length <= 10
            );

            if (missingSections.length > 0) {
              core.setOutput("is_invalid", "true");
              const message = `PR description does not follow the required template. Please update it to include:\n\n` +
                              requiredSections.map(s => `- ${s}`).join("\n") +
                              "\n\n‚ùå PR merge is blocked until this is fixed.";
              core.setOutput("comment_body", message);
            } else {
              core.setOutput("is_invalid", "false");
            }

      - name: Post or update PR comment
        if: steps.validate_description.outputs.is_invalid == 'true'
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ env.PR_NUMBER }}
          comment-tag: pr-description-check
          mode: recreate
          message: ${{ steps.validate_description.outputs.comment_body }}

      - name: Delete PR comment if valid
        if: steps.validate_description.outputs.is_invalid == 'false'
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ env.PR_NUMBER }}
          comment-tag: pr-description-check
          mode: delete
