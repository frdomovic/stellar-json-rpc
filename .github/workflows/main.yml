name: PR
on:
  pull_request:
    types: [opened, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-description:
    name: Check PR Description
    runs-on: ubuntu-latest
    outputs:
      comment_action: ${{ steps.determine_action.outputs.comment_action }}
      comment_content: ${{ steps.determine_action.outputs.comment_content }}
    steps:
      - name: Validate PR Description
        id: determine_action
        uses: actions/github-script@v7
        with:
          script: |
            const requiredSections = [
              "## Description",
              "## Test plan",
              "## Documentation update"
            ];

            const prBody = context.payload.pull_request.body || "";
            const missingSections = requiredSections.filter(section => 
              !prBody.includes(section) || prBody.split(section)[1].trim().length <= 10
            );

            let action = "delete";
            let message = "";

            if (missingSections.length > 0) {
              action = "recreate";
              message = `**PR description is missing required sections!**\n\n` +
                requiredSections.map(s => `- ${s}`).join("\n") +
                `\n\n❌ **PR merge is blocked until this is fixed.**`;
            }

            core.setOutput("comment_action", action);
            core.setOutput("comment_content", message);

  update-comment:
    name: Update PR Comment
    runs-on: ubuntu-latest
    needs: check-description
    if: needs.check-description.outputs.comment_action != 'delete'
    steps:
      - name: Write comment content to file
        run: echo "${{ needs.check-description.outputs.comment_content }}" > comment.md

      - name: Post or update PR comment
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: ./comment.md
          pr-number: ${{ github.event.pull_request.number }}
          comment-tag: pr-description-check
          mode: ${{ needs.check-description.outputs.comment_action }}
