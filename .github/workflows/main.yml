name: PR
on:
  pull_request:
    types: [opened, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-description:
    name: Check PR Description
    runs-on: ubuntu-latest
    outputs:
      comment_action: ${{ steps.determine_action.outputs.comment_action }}
      comment_content: ${{ steps.determine_action.outputs.comment_content }}
      comment_id: ${{ steps.find_comment.outputs.comment_id }}
    steps:
      - name: Validate PR Description
        id: determine_action
        uses: actions/github-script@v7
        with:
          script: |
            const requiredSections = [
              "## Description",
              "## Test plan",
              "## Documentation update"
            ];

            const prBody = context.payload.pull_request.body || "";
            const missingSections = requiredSections.filter(section => 
              !prBody.includes(section) || prBody.split(section)[1].trim().length <= 10
            );

            let action = "create";  // Default to create a new comment
            let message = "";

            if (missingSections.length > 0) {
              action = "recreate";  // Recreate the comment if sections are missing
              message = `**PR description is missing required sections!**\n\n` +
                requiredSections.map(s => `- ${s}`).join("\n") +
                `\n\n❌ **PR merge is blocked until this is fixed.**`;
            } else {
              action = "delete";  // If description is valid, delete the comment
              message = "";  // No message needed if deleting the comment
            }

            core.setOutput("comment_action", action);
            core.setOutput("comment_content", message);

      - name: Find Existing Comment
        id: find_comment
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const existingComment = comments.data.find(comment => 
              comment.body.includes("PR description is missing required sections!")
            );

            if (existingComment) {
              core.setOutput("comment_id", existingComment.id);
            }

  update-comment:
    name: Update or Delete PR Comment
    runs-on: ubuntu-latest
    needs: check-description
    if: needs.check-description.outputs.comment_action != 'delete'
    steps:
      - name: Write comment content to file
        run: echo "${{ needs.check-description.outputs.comment_content }}" > comment.md

      - name: Post or update PR comment
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: ./comment.md
          pr-number: ${{ github.event.pull_request.number }}
          comment-tag: pr-description-check
          mode: ${{ needs.check-description.outputs.comment_action }}

      - name: Delete PR Comment if Valid
        if: needs.check-description.outputs.comment_action == 'delete' && needs.check-description.outputs.comment_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = "${{ needs.check-description.outputs.comment_id }}";
            await github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId
            });
